{% extends "base.html" %}
{% block title %}Chat Room - AIMultiChat{% endblock %}

{% block content %}
<h1>Chat Room</h1>

<!-- Participant list display -->
<div id="participants" class="border rounded p-3 mb-3" style="margin-bottom: 15px;">
  <strong>Participants:</strong>
  <ul id="participantList"></ul>
</div>

<!-- Chat messages display -->
<div id="chat" class="border rounded p-3 mb-3" style="height:300px; overflow-y:scroll;">
  {% for msg in messages %}
    <p id="message-{{ msg.id }}" style="margin: 5px 0;">
      <strong>#{{ msg.room_message_id }} {{ msg.sender_name or 'Anonymous' }}:</strong>
      {{ msg.message }}

      {% if session.get('is_admin') %}
        <!-- Admin-only delete button -->
        <button class="btn btn-danger btn-sm" onclick="deleteMessage('{{ msg.id }}')">ðŸ—‘</button>
      {% endif %}
    </p>
  {% endfor %}
</div>

<!-- New message input -->
<div class="input-group mb-3">
  <input type="text" id="messageInput" class="form-control" placeholder="Type a message..." autocomplete="off">
  <button onclick="sendMessage()" class="btn btn-primary">Send</button>
</div>

<!-- AI Personalities Section -->
<h3>AI Personalities</h3>
<div class="input-group mb-3" style="max-width: 400px;">
  <select id="personalitySelector" class="form-select">
    {% for personality in personalities %}
      <option value="{{ personality }}">{{ personality }}</option>
    {% endfor %}
  </select>
  <button class="btn btn-success" onclick="addPersonality()">Add</button>
  <button class="btn btn-secondary" onclick="removePersonality()">Remove</button>
</div>

<!-- Include Socket.IO Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>
<script>
  // Get the chat's join_code (UUID) from the server
  const chatId = "{{ chat_id }}";

  // Check if the user is authenticated (string check comparing "True")
  const isAuthenticated = "{{ 'user_id' in session }}" === "True";
  // If authenticated, use the user's friendly name. Otherwise, generate a random anon name.
  const username = isAuthenticated ? "{{ session['username'] }}" : `anon-${Math.floor(Math.random() * 900) + 100}`;

  // Connect to the Socket.IO server
  const socket = io();

  // On connect, join the chat room
  socket.on('connect', () => {
    console.log("Connected to Socket.IO server!");
    socket.emit('join', { chat_id: chatId, username: username });

    // Scroll to the bottom of the chat after loading
    setTimeout(() => {
      const chatDiv = document.getElementById('chat');
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }, 100);
  });

  // Show real-time status updates (e.g. user joined/left)
  socket.on('status', (data) => {
    console.log("Received status event:", data);
    const chatDiv = document.getElementById('chat');
    const p = document.createElement('p');
    p.textContent = data.msg;
    chatDiv.appendChild(p);
    chatDiv.scrollTop = chatDiv.scrollHeight;
  });

  // Display new chat messages in real time
  // If you don't already have a JavaScript variable for admin, define one:
  const isAdmin = "{{ session.get('is_admin') }}" === "True";

  socket.on('chat_message', (data) => {
    console.log("Received chat_message event:", data);
    const chatDiv = document.getElementById('chat');

    // Create a new paragraph element for the incoming message
    const p = document.createElement('p');
    p.style.margin = '5px 0';

    // Assign a DOM ID like message-<db_id>
    p.id = `message-${data.db_id}`;

    // Build the HTML
    let html = `<strong>#${data.room_message_id} ${data.username}:</strong> ${data.message}`;

    // If the user is an admin, add a trash button
    if (isAdmin) {
      html += ` <button class="btn btn-danger btn-sm"
                    onclick="deleteMessage('${data.db_id}')">ðŸ—‘</button>`;
    }

    // Insert the final HTML
    p.innerHTML = html;
    chatDiv.appendChild(p);
    chatDiv.scrollTop = chatDiv.scrollHeight;
  });


  // Update the participant list
  socket.on('participant_update', (data) => {
    console.log("Received participant_update event:", data);
    const participantList = document.getElementById('participantList');
    participantList.innerHTML = '';

    data.participants.forEach(participant => {
      const li = document.createElement('li');
      li.textContent = participant;
      participantList.appendChild(li);
    });
  });

  // Sending a new message
  function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    if (!message) return;

    socket.emit('chat_message', {
      chat_id: chatId,   // The chat's join_code
      username: username,
      message: message,
      sender_id: 0       // Placeholder ID; real logic can store actual user_id if desired
    });

    input.value = "";
  }

  // Press enter to send
  document.getElementById('messageInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });

  // When user navigates away, leave the chat
  window.onbeforeunload = () => {
    socket.emit('leave', { chat_id: chatId, username: username });
  };

  // =============== PERSONALITY FEATURES ===============
  function addPersonality() {
    const selectedPersonality = document.getElementById("personalitySelector").value;
    console.log(`DEBUG: Adding personality '${selectedPersonality}' to chat ${chatId}`);
    socket.emit('add_personality', {
      chat_id: chatId,
      personality: selectedPersonality
    });
  }

  function removePersonality() {
    const selectedPersonality = document.getElementById("personalitySelector").value;
    console.log(`DEBUG: Removing personality '${selectedPersonality}' from chat ${chatId}`);
    socket.emit('remove_personality', {
      chat_id: chatId,
      personality: selectedPersonality
    });
  }

  // =============== ADMIN MESSAGE DELETION ===============
  function deleteMessage(messageId) {
    console.log(`DEBUG: Admin deleting message ID=${messageId} in chat=${chatId}`);
    socket.emit('delete_message', {
      chat_id: chatId,
      message_id: messageId
    });
  }

  socket.on('message_deleted', (data) => {
    console.log("Received message_deleted event:", data);
    const msgElem = document.getElementById(`message-${data.message_id}`);
    if (msgElem) {
      msgElem.remove();
    }
  });
</script>
{% endblock %}
